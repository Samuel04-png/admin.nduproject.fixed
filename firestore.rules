rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(ownerId) {
      return isAuthenticated() && request.auth.uid == ownerId;
    }

    // Helper function to check if user has admin privileges
    function isAdmin() {
      return isAuthenticated()
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow delete: if isAuthenticated() && isAdmin();
    }
    
    // Projects collection
    match /projects/{projectId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.ownerId;
      allow update: if isAuthenticated() && (
        request.auth.uid == resource.data.ownerId ||
        request.auth.uid in resource.data.get('teamMembers', []) ||
        isAdmin()
      );
      allow delete: if isAuthenticated() && (request.auth.uid == resource.data.ownerId || isAdmin());
      
      // Execution subcollections
      match /execution_tools/{toolId} {
        allow read, write: if isAuthenticated();
      }
      match /execution_issues/{issueId} {
        allow read, write: if isAuthenticated();
      }
      match /execution_enabling_works/{workId} {
        allow read, write: if isAuthenticated();
      }
      match /execution_change_requests/{requestId} {
        allow read, write: if isAuthenticated();
      }
      
      // Vendor subcollection
      match /vendors/{vendorId} {
        allow read, write: if isAuthenticated();
      }

      // Team management subcollection
      match /team_members/{memberId} {
        allow read, write: if isAuthenticated();
      }
      
      // Contract subcollection
      match /contracts/{contractId} {
        allow read, write: if isAuthenticated();
      }
      
      // Contracting dashboard subcollection
      match /contracting/{docId} {
        allow read, write: if isAuthenticated();
      }

      // Cost estimate subcollection
      match /cost_estimate_items/{itemId} {
        allow read, write: if isAuthenticated();
      }
      
      // Ops subcollections
      match /ops_members/{memberId} {
        allow read, write: if isAuthenticated();
      }
      match /ops_checklist/{itemId} {
        allow read, write: if isAuthenticated();
      }
      match /launch_phase/{docId} {
        allow read, write: if isAuthenticated();
      }
      match /opsMaintenance/{docId} {
        allow read, write: if isAuthenticated();
        match /{subDoc=**} {
          allow read, write: if isAuthenticated();
        }
      }
      
      // Agile subcollection
      match /agile_stories/{storyId} {
        allow read, write: if isAuthenticated();
      }
      
      // Salvage subcollections
      match /salvage_team_members/{memberId} {
        allow read, write: if isAuthenticated();
      }
      match /salvage_inventory/{itemId} {
        allow read, write: if isAuthenticated();
      }
      match /salvage_disposal/{itemId} {
        allow read, write: if isAuthenticated();
      }
      
      // Tools integration subcollection
      match /tool_integrations/{integrationId} {
        allow read, write: if isAuthenticated();
      }
    }
    
    // Programs collection
    match /programs/{programId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.ownerId;
      allow update: if isAuthenticated() && (request.auth.uid == resource.data.ownerId || isAdmin());
      allow delete: if isAuthenticated() && (request.auth.uid == resource.data.ownerId || isAdmin());
    }
    
    // Portfolios collection
    match /portfolios/{portfolioId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.ownerId;
      allow update: if isAuthenticated() && (request.auth.uid == resource.data.ownerId || isAdmin());
      allow delete: if isAuthenticated() && (request.auth.uid == resource.data.ownerId || isAdmin());
    }
    
    // App content collection (for admin content management)
    match /app_content/{contentId} {
      allow read: if true; // Public read access
      allow write: if isAdmin(); // Admin-only write access
    }
    
    // Change requests collection
    match /change_requests/{requestId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Contracts collection
    match /contracts/{contractId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // Subscriptions collection - users can only read their own subscriptions
    // Users can create trial subscriptions, other writes handled by Cloud Functions
    match /subscriptions/{subscriptionId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      // Allow users to create trial subscriptions for themselves
      allow create: if isAuthenticated() && (
        (request.resource.data.userId == request.auth.uid
          && request.resource.data.isTrial == true
          && request.resource.data.status == 'trial')
        || isAdmin()
      );
      allow update: if isAdmin(); // Admin dashboard can update subscriptions
      allow delete: if isAdmin(); // Admin dashboard can delete subscriptions
    }

    // Coupons collection (admin only)
    match /coupons/{couponId} {
      allow read, write: if isAdmin();
    }
    
    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
